{
  "id": "CVE-2024-40979",
  "sourceIdentifier": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
  "published": "2024-07-12T13:15:19.477",
  "lastModified": "2025-09-17T14:57:57.393",
  "vulnStatus": "Analyzed",
  "cveTags": [

  ],
  "descriptions": [
    {
      "lang": "en",
      "value": "In the Linux kernel, the following vulnerability has been resolved:\n\nwifi: ath12k: fix kernel crash during resume\n\nCurrently during resume, QMI target memory is not properly handled, resulting\nin kernel crash in case DMA remap is not supported:\n\nBUG: Bad page state in process kworker/u16:54  pfn:36e80\npage: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x36e80\npage dumped because: nonzero _refcount\nCall Trace:\n bad_page\n free_page_is_bad_report\n __free_pages_ok\n __free_pages\n dma_direct_free\n dma_free_attrs\n ath12k_qmi_free_target_mem_chunk\n ath12k_qmi_msg_mem_request_cb\n\nThe reason is:\nOnce ath12k module is loaded, firmware sends memory request to host. In case\nDMA remap not supported, ath12k refuses the first request due to failure in\nallocating with large segment size:\n\nath12k_pci 0000:04:00.0: qmi firmware request memory request\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 7077888\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 8454144\nath12k_pci 0000:04:00.0: qmi dma allocation failed (7077888 B type 1), will try later with small size\nath12k_pci 0000:04:00.0: qmi delays mem_request 2\nath12k_pci 0000:04:00.0: qmi firmware request memory request\n\nLater firmware comes back with more but small segments and allocation\nsucceeds:\n\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 262144\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 524288\nath12k_pci 0000:04:00.0: qmi mem seg type 4 size 65536\nath12k_pci 0000:04:00.0: qmi mem seg type 1 size 524288\n\nNow ath12k is working. If suspend is triggered, firmware will be reloaded\nduring resume. As same as before, firmware requests two large segments at\nfirst. In ath12k_qmi_msg_mem_request_cb() segment count and size are\nassigned:\n\n\tab->qmi.mem_seg_count == 2\n\tab->qmi.target_mem[0].size == 7077888\n\tab->qmi.target_mem[1].size == 8454144\n\nThen allocation failed like before and ath12k_qmi_free_target_mem_chunk()\nis called to free all allocated segments. Note the first segment is skipped\nbecause its v.addr is cleared due to allocation failure:\n\n\tchunk->v.addr = dma_alloc_coherent()\n\nAlso note that this leaks that segment because it has not been freed.\n\nWhile freeing the second segment, a size of 8454144 is passed to\ndma_free_coherent(). However remember that this segment is allocated at\nthe first time firmware is loaded, before suspend. So its real size is\n524288, much smaller than 8454144. As a result kernel found we are freeing\nsome memory which is in use and thus cras\n---truncated---"
    },
    {
      "lang": "es",
      "value": "En el kernel de Linux, se ha resuelto la siguiente vulnerabilidad: wifi: ath12k: soluciona el fallo del kernel durante la reanudación Actualmente, durante la reanudación, la memoria de destino de QMI no se maneja adecuadamente, lo que provoca un fallo del kernel en caso de que no se admita la reasignación de DMA: ERROR: Estado incorrecto de la página en proceso kworker/u16:54 pfn:36e80 página: refcount:1 mapcount:0 mapeo:0000000000000000 index:0x0 pfn:0x36e80 página descargada porque: distinto de cero _refcount Rastreo de llamadas: bad_page free_page_is_bad_report __free_pages_ok __free_pages dma_direct_free dma_free_attrs a th12k_qmi_free_target_mem_chunk ath12k_qmi_msg_mem_request_cb El motivo es: Una vez ath12k El módulo está cargado, el firmware envía la solicitud de memoria al host. En caso de que no se admita la reasignación de DMA, ath12k rechaza la primera solicitud debido a un error en la asignación con un tamaño de segmento grande: ath12k_pci 0000:04:00.0: solicitud de firmware qmi solicitud de memoria ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 7077888 ath12k_pci 0000 :04:00.0: qmi mem seg tipo 4 tamaño 8454144 ath12k_pci 0000:04:00.0: falla en la asignación de qmi dma (7077888 B tipo 1), lo intentaré más tarde con un tamaño pequeño ath12k_pci 0000:04:00.0: qmi retrasa mem_request 2 ath12k_pci 0000: 04:00.0: solicitud de memoria de solicitud de firmware qmi El firmware posterior regresa con más segmentos, pero pequeños, y la asignación se realiza correctamente: ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 pci 0000:04:00.0:qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 262144 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000 :04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 ath12k_pci 0000:04:00 .0: segmento de memoria qmi tipo 1 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 24288 ath12k_pci 0000:04 :00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 5242 88 ath12k_pci 0000:04:00.0 : qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem se g tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 524288 ath12k_pci 0000:04:00.0: qmi mem seg tipo 4 tamaño 65536 ci 0000:04:00.0: qmi mem seg tipo 1 tamaño 524288 Ahora ath12k está funcionando. Si se activa la suspensión, el firmware se recargará durante la reanudación. Al igual que antes, el firmware solicita dos segmentos grandes al principio. En ath12k_qmi_msg_mem_request_cb() se asigna el recuento y el tamaño del segmento: ab-&gt;qmi.mem_seg_count == 2 ab-&gt;qmi.target_mem[0].size == 7077888 ab-&gt;qmi.target_mem[1].size == 8454144 Luego, la asignación falló como antes y se llama a ath12k_qmi_free_target_mem_chunk() para liberar todos los segmentos asignados. ---truncado---"
    }
  ],
  "metrics": {
    "cvssMetricV31": [
      {
        "source": "nvd@nist.gov",
        "type": "Primary",
        "cvssData": {
          "version": "3.1",
          "vectorString": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
          "baseScore": 5.5,
          "baseSeverity": "MEDIUM",
          "attackVector": "LOCAL",
          "attackComplexity": "LOW",
          "privilegesRequired": "LOW",
          "userInteraction": "NONE",
          "scope": "UNCHANGED",
          "confidentialityImpact": "NONE",
          "integrityImpact": "NONE",
          "availabilityImpact": "HIGH"
        },
        "exploitabilityScore": 1.8,
        "impactScore": 3.6
      }
    ]
  },
  "weaknesses": [
    {
      "source": "nvd@nist.gov",
      "type": "Primary",
      "description": [
        {
          "lang": "en",
          "value": "CWE-401"
        },
        {
          "lang": "en",
          "value": "CWE-763"
        }
      ]
    }
  ],
  "configurations": [
    {
      "nodes": [
        {
          "operator": "OR",
          "negate": false,
          "cpeMatch": [
            {
              "vulnerable": true,
              "criteria": "cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*",
              "versionStartIncluding": "6.3",
              "versionEndExcluding": "6.9.7",
              "matchCriteriaId": "A4D18378-D3B8-448E-A8B7-1B21462922D2"
            }
          ]
        }
      ]
    }
  ],
  "references": [
    {
      "url": "https://git.kernel.org/stable/c/303c017821d88ebad887814114d4e5966d320b28",
      "source": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://git.kernel.org/stable/c/bb50a4e711ff95348ad53641acb1306d89eb4c3a",
      "source": "416baaa9-dc9f-4396-8d5f-8c081fb06d67",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://git.kernel.org/stable/c/303c017821d88ebad887814114d4e5966d320b28",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    },
    {
      "url": "https://git.kernel.org/stable/c/bb50a4e711ff95348ad53641acb1306d89eb4c3a",
      "source": "af854a3a-2127-422b-91ae-364da2661108",
      "tags": [
        "Patch"
      ]
    }
  ]
}